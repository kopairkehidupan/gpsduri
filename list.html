<!-- list.html -->
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Daftar Sensus per Blok</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background-color: #f2f2f2; }
    .btn-view { background-color: #2196F3; color: white; border: none; padding: 6px 12px; cursor: pointer; border-radius: 4px; }
  </style>
</head>
<body>

<h2>Daftar Blok Hasil Sensus</h2>
<table id="blokTable">
  <thead>
    <tr>
      <th>Kebun</th>
      <th>Divisi</th>
      <th>Blok</th>
      <th>Aksi</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTYyCf6JfGComZrmquPZ487oZPME6IE1YOdQ530KQN2OQsP_aWxTx8CYvKjGjHB7riZnIh3pArGw8t2/pub?output=csv";

fetch(SHEET_CSV_URL)
  .then(res => res.text())
  .then(csv => {
    const rows = csv.trim().split("\n").slice(1);
    const dataByBlok = {};

    rows.forEach(row => {
      const cols = row.split(',').map(c => c.replace(/^"|"$/g, ''));
      const [_, kebun, divisi, blok, dataType, fileName, fileUrl] = cols;
      const key = `${kebun}|${divisi}|${blok}`;

      if (!dataByBlok[key]) dataByBlok[key] = { kebun, divisi, blok, waypoints: [], tracks: [] };
      if (dataType.toUpperCase() === 'WAYPOINT') {
        dataByBlok[key].waypoints.push(fileUrl);
      } else if (dataType.toUpperCase() === 'TRACK') {
        dataByBlok[key].tracks.push(fileUrl);
      }
    });

    const tbody = document.querySelector("#blokTable tbody");

    Object.values(dataByBlok).forEach(entry => {
      const tr = document.createElement("tr");

      [entry.kebun, entry.divisi, entry.blok].forEach(text => {
        const td = document.createElement("td");
        td.textContent = text;
        tr.appendChild(td);
      });

      const tdAction = document.createElement("td");
      const btn = document.createElement("button");
      btn.className = "btn-view";
      btn.textContent = "Lihat di Peta";
      btn.onclick = () => {
        const params = new URLSearchParams();
        params.append("blok", entry.blok);
        params.append("kebun", entry.kebun);
        params.append("divisi", entry.divisi);
        entry.waypoints.forEach(url => params.append("waypoints", url));
        entry.tracks.forEach(url => params.append("tracks", url));

        window.open(`viewpeta.html?${params.toString()}`, "_blank");
      };
      tdAction.appendChild(btn);
      tr.appendChild(tdAction);

      tbody.appendChild(tr);
    });
  });
</script>

</body>
</html>
