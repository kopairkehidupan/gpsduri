<!DOCTYPE html>
<html>
<head>
  <title>Sensus Pokok Kebun Duri</title>
  <meta charset="utf-8" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body {
      height: 100%;
      margin: 0;
    }
    #map {
      height: 100%;
      width: 100%;
    }
    .leaflet-marker-icon.circle-icon {
      border-radius: 50% !important;
      border: 1px solid #555;
      object-fit: cover;
      background: white;
      width: 24px !important;
      height: 24px !important;
    }
    .map-controls {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000;
      background: white;
      padding: 10px;
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
    }
    .loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1000;
      background: white;
      padding: 20px;
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
    }
  </style>
</head>
<body>

<div id="loading" class="loading">Loading map data...</div>
<div id="map"></div>
<div class="map-controls">
  <h3 id="blok-title">Blok: Loading...</h3>
  <div id="file-list"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/gpx.min.js"></script>
<script>
  const urlParams = new URLSearchParams(window.location.search);
  const blok = urlParams.get('blok');
  const kebun = urlParams.get('kebun');
  const divisi = urlParams.get('divisi');

  document.getElementById('blok-title').textContent = `Blok: ${blok || 'Unknown'}`;

  const map = L.map('map').setView([1.17, 100.99], 15);

  L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    attribution: 'KPAK',
    maxZoom: 22
  }).addTo(map);

  function getWaypointIcon(symbol) {
    const sym = (symbol || '').toLowerCase().trim();
    let iconUrl = 'https://kopairkehidupan.github.io/gpsduri/blue-flag-cropped.png';
    if (sym === 'flag, green') {
      iconUrl = 'https://kopairkehidupan.github.io/gpsduri/green-flag-cropped.png';
    } else if (sym === 'navaid, black') {
      iconUrl = 'https://kopairkehidupan.github.io/gpsduri/black-flag-cropped.png';
    }
    return new L.Icon({
      iconUrl,
      iconSize: [20, 20],
      iconAnchor: [10, 10],
      popupAnchor: [0, -10]
    });
  }

  async function fetchPublicCSV() {
    const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTYyCf6JfGComZrmquPZ487oZPME6IE1YOdQ530KQN2OQsP_aWxTx8CYvKjGjHB7riZnIh3pArGw8t2/pub?output=csv";
    const res = await fetch(csvUrl);
    return await res.text();
  }

  async function fetchFileFromDrive(url) {
    const fileId = url.match(/\/file\/d\/([^\/]+)/)[1];
    const directUrl = `https://drive.google.com/uc?export=download&id=${fileId}`;
    const res = await fetch(directUrl);
    if (!res.ok) throw new Error(`Failed to fetch file: ${url}`);
    return await res.text();
  }

  function addGpxToMap(gpxContent, type) {
    const parser = new DOMParser();
    const xml = parser.parseFromString(gpxContent, "application/xml");

    if (type === 'waypoint') {
      const waypoints = xml.getElementsByTagName('wpt');
      const bounds = [];
      for (let wpt of waypoints) {
        const lat = parseFloat(wpt.getAttribute('lat'));
        const lon = parseFloat(wpt.getAttribute('lon'));
        const name = wpt.getElementsByTagName('name')[0]?.textContent || 'Unknown';
        const sym = wpt.getElementsByTagName('sym')[0]?.textContent || '';
        const marker = L.marker([lat, lon], {
          icon: getWaypointIcon(sym)
        }).addTo(map);
        marker.bindPopup(`<b>Waypoint:</b> ${name}<br><b>Symbol:</b> ${sym}`);
        bounds.push([lat, lon]);
      }
      if (bounds.length) {
        map.fitBounds(bounds, { padding: [50, 50], maxZoom: 20 });
      }
    } else if (type === 'track') {
      const gpxLayer = new L.GPX(gpxContent, {
        async: true,
        polyline_options: { color: 'red', opacity: 0.75, weight: 4 }
      }).addTo(map);
      gpxLayer.on('loaded', function(e) {
        map.fitBounds(e.target.getBounds(), { padding: [50, 50] });
      });
    }
  }

  async function processData() {
    const loading = document.getElementById('loading');
    const listEl = document.getElementById('file-list');
    listEl.innerHTML = '<h4>Loaded Files:</h4><ul></ul>';
    const ul = listEl.querySelector('ul');

    try {
      const csv = await fetchPublicCSV();
      const rows = csv.split("\n").slice(1);
      for (const row of rows) {
        const cols = row.split(",").map(c => c.replace(/^"|"$/g, '').trim());
        if (cols.length < 8) continue;
        const [ , kebunData, divisiData, blokData, tipe, namaFile, fileUrl ] = cols;

        if (kebunData === kebun && divisiData === divisi && blokData === blok) {
          const li = document.createElement('li');
          li.textContent = `${tipe}: ${namaFile}`;
          ul.appendChild(li);

          const content = await fetchFileFromDrive(fileUrl);
          addGpxToMap(content, tipe.toLowerCase());
        }
      }
    } catch (err) {
      console.error('Error processing files:', err);
    } finally {
      loading.style.display = 'none';
    }
  }

  processData();
</script>

</body>
</html>
